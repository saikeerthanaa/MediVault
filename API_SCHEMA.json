{
  "title": "MediVault AI Pipeline - Complete JSON Schema",
  "description": "Exact JSON structure and keys for all endpoints (for deterministic hashing and consistency)",
  "version": "1.0",
  
  "endpoints": {
    "POST /ai/process-document": {
      "description": "Extract text from image using AWS Textract",
      "response": {
        "ok": "boolean",
        "raw_text": "string (extracted OCR text)",
        "confidence": "number (0-100, from AWS Textract)",
        "requires_review": "boolean",
        "blocks": [
          {
            "text": "string",
            "confidence": "number",
            "bounding_box": "object (x, y, width, height)"
          }
        ]
      }
    },
    
    "POST /ai/normalize-and-extract": {
      "description": "Normalize OCR text and extract medical entities (medications, conditions, allergies)",
      "request": {
        "reviewed_text": "string (required)",
        "patient_verified": "boolean (optional)",
        "ocr_confidence": "number (optional, 0-100)",
        "debug": "boolean (optional)"
      },
      "response": {
        "ok": "boolean",
        "normalized": {
          "cleaned_text": "string (corrected OCR text)",
          "corrections": [
            {
              "original": "string",
              "corrected": "string",
              "type": "enum: ocr_char_fix | abbrev_expansion",
              "confidence": "number (0-1)",
              "source": "string (pattern_match or bedrock)"
            }
          ],
          "confidence": "number (0-1)",
          "flags": ["string[]"],
          "needs_term_review": "boolean"
        },
        "entities": {
          "medications": [
            {
              "name": "string",
              "dosage": "string",
              "frequency": "string",
              "duration": "string",
              "route": "string",
              "notes": "string (optional)",
              "schedule": {
                "frequency_per_day": "number",
                "as_needed": "boolean",
                "duration_days": "number | null",
                "instructions": "string",
                "uncertainty": "boolean"
              }
            }
          ],
          "conditions": ["string[]"],
          "allergies": ["string[]"],
          "lab_values": ["{}[]"]
        },
        "extraction_debug": {
          "bedrock_ok": "boolean",
          "bedrock_med_count": "number",
          "fuzzy_med_count": "number",
          "merged_count": "number",
          "model_used": "string",
          "api_method": "string",
          "clean_text_preview": "string"
        }
      }
    },
    
    "POST /ai/check-interaction": {
      "description": "Check drug interactions between medications",
      "request": {
        "new_med": "string (medication name)",
        "current_meds": ["string[]"]
      },
      "response": {
        "ok": "boolean",
        "new_med": "string",
        "current_meds": ["string[]"],
        "interactions": [
          {
            "severity": "enum: unknown | minor | moderate | high",
            "summary": "string (short description)",
            "mechanism": "string (how interaction occurs)",
            "action": "string (recommended action)",
            "citations": [
              {
                "title": "string",
                "snippet": "string",
                "source_uri": "string",
                "relevance_score": "number"
              }
            ]
          }
        ]
      }
    },
    
    "POST /ai/tts": {
      "description": "Text-to-speech synthesis using AWS Polly",
      "request": {
        "text": "string (text to synthesize)",
        "voice_id": "enum: Joanna | Matthew | Raveesh | Aditi"
      },
      "response": {
        "audio_bytes": "bytes (audio/mpeg)"
      }
    },
    
    "POST /ai/save-prescription": {
      "description": "Save prescription to database and perform interaction checks",
      "request": {
        "patient_id": "number",
        "doctor_id": "number",
        "s3_image_url": "string",
        "entities": {
          "medications": "{}[]",
          "conditions": "string[]",
          "allergies": "string[]",
          "lab_values": "{}[]"
        }
      },
      "response": {
        "ok": "boolean",
        "prescription_id": "number",
        "medicines_saved": "number",
        "interactions": [
          {
            "severity": "string",
            "drug1": "string",
            "drug2": "string",
            "description": "string"
          }
        ],
        "warnings": ["string[]"],
        "fhir_bundle": "object (optional)"
      }
    }
  },
  
  "database_schema": {
    "prescriptions": {
      "columns": {
        "id": "INT PRIMARY KEY AUTO_INCREMENT",
        "patient_id": "INT",
        "doctor_id": "INT",
        "prescribed_date": "DATE",
        "s3_image_url": "VARCHAR(500)",
        "fhir_bundle": "LONGTEXT (JSON)",
        "created_at": "TIMESTAMP",
        "updated_at": "TIMESTAMP"
      }
    },
    "medicines": {
      "columns": {
        "id": "INT PRIMARY KEY AUTO_INCREMENT",
        "name": "VARCHAR(255) UNIQUE",
        "created_at": "TIMESTAMP"
      }
    },
    "prescription_medicines": {
      "columns": {
        "id": "INT PRIMARY KEY AUTO_INCREMENT",
        "prescription_id": "INT (FK -> prescriptions.id)",
        "medicine_id": "INT (FK -> medicines.id)",
        "dosage": "VARCHAR(255)",
        "frequency": "VARCHAR(255)",
        "duration": "VARCHAR(255)",
        "route": "VARCHAR(255)",
        "created_at": "TIMESTAMP"
      }
    }
  },
  
  "hashing_note": "For deterministic hashing (cybersecurity), ensure these JSON keys are ALWAYS present in the same order, even if empty: ok, normalized, entities. Do not add extra keys dynamically. Use JSON.stringify with sorted keys for hashing."
}
