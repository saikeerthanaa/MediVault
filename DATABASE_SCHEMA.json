{
  "title": "Database Schema & Lab Reports Structure",
  "description": "Complete database design and new lab reports table structure",
  "version": "2.0",
  
  "existing_tables": {
    "prescriptions": {
      "purpose": "Store prescription documents and extracted data",
      "columns": [
        {
          "name": "id",
          "type": "INT",
          "constraint": "PRIMARY KEY AUTO_INCREMENT",
          "description": "Unique prescription ID"
        },
        {
          "name": "patient_id",
          "type": "INT",
          "constraint": "FOREIGN KEY (patients table)",
          "description": "Reference to patient"
        },
        {
          "name": "doctor_id",
          "type": "INT",
          "constraint": "FOREIGN KEY (doctors table)",
          "description": "Reference to prescribing doctor"
        },
        {
          "name": "prescribed_date",
          "type": "DATE",
          "constraint": "NOT NULL",
          "description": "Date prescription was written"
        },
        {
          "name": "s3_image_url",
          "type": "VARCHAR(500)",
          "constraint": "NULLABLE",
          "description": "URL to original prescription image on S3"
        },
        {
          "name": "fhir_bundle",
          "type": "LONGTEXT",
          "constraint": "NULLABLE",
          "description": "FHIR bundle JSON representation"
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraint": "DEFAULT CURRENT_TIMESTAMP",
          "description": "When record was created"
        },
        {
          "name": "updated_at",
          "type": "TIMESTAMP",
          "constraint": "DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP",
          "description": "Last update time"
        }
      ],
      "example_row": {
        "id": 42,
        "patient_id": 103,
        "doctor_id": 7,
        "prescribed_date": "2025-02-28",
        "s3_image_url": "s3://medivault/prescriptions/rx_42.jpg",
        "fhir_bundle": "{\"resourceType\": \"Bundle\", ...}",
        "created_at": "2025-02-28 14:32:00",
        "updated_at": "2025-02-28 14:32:00"
      }
    },
    
    "medicines": {
      "purpose": "Master drug list (normalized names)",
      "columns": [
        {
          "name": "id",
          "type": "INT",
          "constraint": "PRIMARY KEY AUTO_INCREMENT"
        },
        {
          "name": "name",
          "type": "VARCHAR(255)",
          "constraint": "UNIQUE NOT NULL",
          "description": "Canonical drug name (e.g. 'Aspirin', 'Metformin')"
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraint": "DEFAULT CURRENT_TIMESTAMP"
        }
      ],
      "example_row": {
        "id": 1,
        "name": "Aspirin",
        "created_at": "2025-02-28 14:32:00"
      }
    },
    
    "prescription_medicines": {
      "purpose": "Junction table: links prescriptions to medicines with dosing info",
      "columns": [
        {
          "name": "id",
          "type": "INT",
          "constraint": "PRIMARY KEY AUTO_INCREMENT"
        },
        {
          "name": "prescription_id",
          "type": "INT",
          "constraint": "FOREIGN KEY (prescriptions.id)",
          "description": "Reference to prescription"
        },
        {
          "name": "medicine_id",
          "type": "INT",
          "constraint": "FOREIGN KEY (medicines.id)",
          "description": "Reference to medicine"
        },
        {
          "name": "dosage",
          "type": "VARCHAR(255)",
          "constraint": "NULLABLE",
          "description": "e.g. '500mg', '2 tabs'"
        },
        {
          "name": "frequency",
          "type": "VARCHAR(255)",
          "constraint": "NULLABLE",
          "description": "e.g. 'Twice daily', 'Once daily'"
        },
        {
          "name": "duration",
          "type": "VARCHAR(255)",
          "constraint": "NULLABLE",
          "description": "e.g. 'For 7 days', 'Ongoing'"
        },
        {
          "name": "route",
          "type": "VARCHAR(255)",
          "constraint": "NULLABLE",
          "description": "e.g. 'Oral', 'Injection', 'Inhalation'"
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraint": "DEFAULT CURRENT_TIMESTAMP"
        }
      ],
      "example_row": {
        "id": 156,
        "prescription_id": 42,
        "medicine_id": 1,
        "dosage": "500mg",
        "frequency": "Twice daily",
        "duration": "For 7 days",
        "route": "Oral",
        "created_at": "2025-02-28 14:32:00"
      }
    }
  },
  
  "new_table_lab_reports": {
    "purpose": "Store lab test reports and extracted lab values",
    "columns": [
      {
        "name": "id",
        "type": "INT",
        "constraint": "PRIMARY KEY AUTO_INCREMENT",
        "description": "Unique lab report ID"
      },
      {
        "name": "patient_id",
        "type": "INT",
        "constraint": "FOREIGN KEY (patients table)",
        "description": "Reference to patient"
      },
      {
        "name": "test_date",
        "type": "DATE",
        "constraint": "NOT NULL",
        "description": "Date lab test was performed"
      },
      {
        "name": "lab_name",
        "type": "VARCHAR(255)",
        "constraint": "NULLABLE",
        "description": "Name of lab/facility (e.g. 'Apollo Diagnostics')"
      },
      {
        "name": "report_type",
        "type": "ENUM('Blood', 'Urine', 'Imaging', 'Pathology', 'Cardiac', 'Other')",
        "constraint": "NOT NULL",
        "description": "Type of lab report"
      },
      {
        "name": "s3_image_url",
        "type": "VARCHAR(500)",
        "constraint": "NULLABLE",
        "description": "URL to original lab report image on S3"
      },
      {
        "name": "ocr_text",
        "type": "LONGTEXT",
        "constraint": "NULLABLE",
        "description": "Raw OCR extracted text from report"
      },
      {
        "name": "lab_values_json",
        "type": "LONGTEXT",
        "constraint": "NOT NULL",
        "description": "Structured lab values JSON (see schema below)"
      },
      {
        "name": "extracted_conditions",
        "type": "JSON",
        "constraint": "NULLABLE",
        "description": "Conditions mentioned in report (array of strings)"
      },
      {
        "name": "created_at",
        "type": "TIMESTAMP",
        "constraint": "DEFAULT CURRENT_TIMESTAMP"
      },
      {
        "name": "updated_at",
        "type": "TIMESTAMP",
        "constraint": "DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP"
      }
    ],
    
    "lab_values_json_structure": {
      "description": "Nested structure for lab_values_json column",
      "schema": {
        "test_results": [
          {
            "test_name": "string (e.g. 'Hemoglobin', 'Blood Glucose')",
            "test_code": "string (e.g. 'HB', 'BS' - optional)",
            "value": "number | string",
            "unit": "string (e.g. 'g/dL', 'mg/dL')",
            "normal_range": {
              "min": "number | null",
              "max": "number | null"
            },
            "status": "enum: NORMAL | LOW | HIGH | CRITICAL",
            "reference_value": "string (optional, for text results)"
          }
        ],
        "critical_flags": [
          {
            "test_name": "string",
            "value": "number | string",
            "severity": "enum: WARNING | CRITICAL",
            "reason": "string"
          }
        ]
      },
      "example_lab_report": {
        "test_results": [
          {
            "test_name": "Hemoglobin",
            "test_code": "HB",
            "value": 13.5,
            "unit": "g/dL",
            "normal_range": {"min": 12, "max": 16},
            "status": "NORMAL"
          },
          {
            "test_name": "Blood Glucose (Fasting)",
            "test_code": "BS",
            "value": 145,
            "unit": "mg/dL",
            "normal_range": {"min": 70, "max": 100},
            "status": "HIGH"
          },
          {
            "test_name": "Serum Creatinine",
            "value": 1.2,
            "unit": "mg/dL",
            "normal_range": {"min": 0.7, "max": 1.3},
            "status": "NORMAL"
          }
        ],
        "critical_flags": [
          {
            "test_name": "Blood Glucose (Fasting)",
            "value": 145,
            "severity": "WARNING",
            "reason": "Elevated - may indicate impaired fasting glucose or diabetes"
          }
        ]
      }
    },
    
    "example_full_row": {
      "id": 15,
      "patient_id": 103,
      "test_date": "2025-02-24",
      "lab_name": "Apollo Diagnostics",
      "report_type": "Blood",
      "s3_image_url": "s3://medivault/labs/report_15.pdf",
      "ocr_text": "Patient: John Doe... Hemoglobin: 13.5 g/dL... Blood Glucose: 145 mg/dL...",
      "lab_values_json": "{\"test_results\": [{...}], \"critical_flags\": [{...}]}",
      "extracted_conditions": "[\"Hyperglycemia\", \"Impaired Fasting Glucose\"]",
      "created_at": "2025-02-24 10:15:00",
      "updated_at": "2025-02-24 10:15:00"
    }
  },
  
  "api_endpoint_for_lab_reports": {
    "POST /ai/process-lab-report": {
      "description": "Upload and process lab report (to be implemented)",
      "request": {
        "patient_id": "number",
        "file": "multipart/form-data (image)",
        "test_date": "YYYY-MM-DD"
      },
      "response": {
        "ok": "boolean",
        "lab_report_id": "number",
        "report_type": "enum",
        "lab_values_extracted": "{}",
        "critical_flags": "[{}]",
        "extracted_conditions": "[string]"
      }
    }
  },
  
  "migration_sql": {
    "create_lab_reports_table": "ALTER TABLE lab_reports MODIFY lab_values_json LONGTEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;",
    "add_indexes": [
      "CREATE INDEX idx_lab_patient ON lab_reports(patient_id);",
      "CREATE INDEX idx_lab_test_date ON lab_reports(test_date);",
      "CREATE INDEX idx_lab_type ON lab_reports(report_type);"
    ]
  },
  
  "communication_guide": {
    "to_cybersecurity_team": "Use API_SCHEMA.json - shows hashing requirements and deterministic structure. All responses must maintain consistent key ordering for cryptographic verification.",
    "to_frontend_team": "Use FRONTEND_DATAFLOW.json - shows step-by-step data flow and state management. Each step extracts specific fields from API responses.",
    "to_database_team": "See lab_reports table schema above. lab_values_json column stores all test results + critical flags. Indexes on patient_id and test_date for fast queries.",
    "to_ml_team": "Output from /ai/normalize-and-extract contains both Bedrock and fuzzy extraction results. Use extracted_debug object to track which extraction method succeeded."
  }
}
